# NewsletterPiano

Python project to retrieve **newsletter analytics** from **Piano** via **API** (ESP / Piano.io).

## What it does

- Queries Piano APIs for newsletter-related data and metrics.
- Configuration via environment variables and a JSON file (`api_key`, `site_id`, optional `name` per publisher).
- Unit tests validate configuration, request building, and API client behaviour.

## Requirements

- Python **3.12+**
- Dependencies: see `requirements.txt`

## Utility: `manage`

The `manage` script handles project setup, keys, tests, and running the app:

```bash
python3 manage -h
```

| Command | Description |
|--------|-------------|
| `manage init` | Create venv and install requirements (optional `--requirements`, `--venv-dir`). |
| `manage add keys [file]` | Create or append API keys in JSON. Use `--from-env` to load from env, or pass `--api_key`, `--site_id`, `--name`. |
| `manage test` | Run unit tests (optional `--pattern`, `--verbosity`, `--start-dir`; default discovery in `./tests`). |
| `manage run` | Run the app (`main.py`). Optional `--skip-env`, `--dry-run` (dry-run runs tests instead). |

## Configuration

### Environment variables

Required:

- **`API_ENDPOINT`** — Piano API base URL (e.g. `https://api-esp.piano.io`).

Optional, for multiple publishers (suffix with `_1`, `_2`, … or leave as default):

- **`PIANO_API_KEY*`** — API key.
- **`PIANO_SITE_ID*`** — Site ID (integer).
- **`PIANO_NAME*`** — Display name (optional).

Example:

```bash
export API_ENDPOINT=https://api-esp.piano.io

export PIANO_API_KEY_1=your_key_1
export PIANO_SITE_ID_1=123
export PIANO_NAME_1=PublisherOne

export PIANO_API_KEY_2=your_key_2
export PIANO_SITE_ID_2=456
```

Load these into the JSON file:

```bash
python3 manage add keys --from-env
```

### JSON file (`publisher_keys.json`)

Stores **api_key**, **site_id**, and optional **name** for each publisher. Must live in the project root (or path you pass to `manage add keys`).

Required structure (as produced by `manage add keys`):

```json
{
  "description": "Generated by manage utilities",
  "items": [
    {
      "api_key": "<your_api_key>",
      "id": 123,
      "name": "Publisher name"
    }
  ]
}
```

- **`items`** — Array of objects; each must have `api_key` and `id` (site_id). `name` is optional.
- **`description`** — Optional; added automatically when using `manage add keys`.

Create or append entries:

```bash
python3 manage add keys --api_key YOUR_KEY --site_id 123 --name "My Site"
python3 manage add keys --from-env
python3 manage add keys --help
```

## Local setup

Manual:

```bash
cd path/to/project
python -m venv .venv
source .venv/bin/activate   # Windows: .venv\Scripts\activate
pip install -r requirements.txt
export API_ENDPOINT=https://api-esp.piano.io
# Create publisher_keys.json (see above) or use: python3 manage add keys --from-env
python3 main.py
```

Or use the helper:

```bash
python3 manage init
python3 manage add keys --from-env   # if using PIANO_* env vars
```

## Containerization

### Docker image

The image runs `python3 manage run` by default (see `Dockerfile`).

```bash
docker build -t newsletter-piano .
docker run --rm \
  -e API_ENDPOINT="https://api-esp.piano.io" \
  -v "./publisher_keys.json:/app/publisher_keys.json" \
  newsletter-piano
```

Use a volume or bind-mount so the container can read `publisher_keys.json` at `/app/publisher_keys.json`.

### Docker Compose

Example for persistent data and config:

```yaml
services:
  newsletter-piano:
    build: .
    image: newsletter-piano:latest
    environment:
      API_ENDPOINT: https://api-esp.piano.io
    volumes:
      - ./data:/app/data
      - ./publisher_keys.json:/app/publisher_keys.json
    restart: unless-stopped
```

Then:

```bash
docker compose up -d
```

## Next up

- [ ] Persist newsletter/campaign data (e.g. DB or exports).
- [ ] Schedule runs (cron, scheduler, or CI) for periodic analytics.
- [ ] Generate and schedule report
- [ ] Extend `PianoESP` usage in `main.py` (e.g. `get_campaign_stats`, date ranges).
- [ ] Optional `.env` loading for local development.

## Reference

- [Piano ESP API](https://docs.piano.io/track/esp/#MLstatistics) — Piano product and ESP.
