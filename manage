#! /usr/bin/env python3

import sys
import os
import argparse
import unittest
import json
from pathlib import Path
from typing import Optional


def create_or_append_key(file: str, api_key: str, site_id: int,
                         name: Optional[str] = None, indent: bool = True) -> None:
    """Create or append an API key to the configuration file."""
    file_path = Path(file)

    # Create new file if it doesn't exist
    if not file_path.exists():
        content = {'items': [{'id': site_id, 'name': name, 'api_key': api_key}], "description": "Generated by manage utilities"}
        _write_json_file(file_path, content, indent)
        print(f"Created new file and added API key for site {site_id}")
        return

    # Load existing file
    try:
        with open(file_path, 'r') as f:
            content_file = json.load(f)
    except json.JSONDecodeError:
        print(f"Error: Invalid JSON in {file}")
        sys.exit(1)

    items = content_file.get('items', [])

    # Check for duplicates
    if any(item.get('api_key') == api_key and item.get('id') == site_id for item in items):
        print(f"API key already exists for site {site_id}")
        return

    # Append new key
    items.append({'id': site_id, 'name': name, 'api_key': api_key})
    content_file['items'] = items

    _write_json_file(file_path, content_file, indent)
    print(f"Added API key for site {site_id}")


def _write_json_file(file_path: Path, content: dict, indent: bool) -> None:
    """Write content to JSON file with optional indentation."""
    with open(file_path, 'w') as f:
        json.dump(content, f, indent=4 if indent else None)


def setup_from_env(file: str) -> None:
    """Load API keys from environment variables and save to file."""
    env_groups = {}

    # Group environment variables by suffix
    for key, value in os.environ.items():
        if key.startswith('PIANO_SITE_ID'):
            suffix = key.replace('PIANO_SITE_ID', '').lstrip('_') or 'default'
            env_groups.setdefault(suffix, {})['site_id'] = value
        elif key.startswith('PIANO_API_KEY'):
            suffix = key.replace('PIANO_API_KEY', '').lstrip('_') or 'default'
            env_groups.setdefault(suffix, {})['api_key'] = value
        elif key.startswith('PIANO_NAME'):
            suffix = key.replace('PIANO_NAME', '').lstrip('_') or 'default'
            env_groups.setdefault(suffix, {})['name'] = value

    # Process grouped environment variables
    if not env_groups:
        print("Warning: No PIANO_* environment variables found")
        return

    for suffix, group in env_groups.items():
        if 'site_id' in group and 'api_key' in group:
            site_id = int(group['site_id'])
            api_key = group['api_key']
            name = group.get('name')
            create_or_append_key(file, api_key, site_id, name, True)
        else:
            print(f"Warning: Incomplete configuration for suffix '{suffix}'")


def parser_args_setup() -> argparse.ArgumentParser:
    """Setup and return the argument parser with all commands and subcommands."""
    parser = argparse.ArgumentParser(
        description='Utility to manage Piano resources',
        prog=sys.argv[0]
    )

    subparsers = parser.add_subparsers(dest='command', help='Available commands', required=True)

    # Add command with subcommands
    _setup_add_command(subparsers)

    # Test command
    _setup_test_command(subparsers)

    # Init command
    _setup_init_command(subparsers)

    # Run command
    _setup_run_command(subparsers)

    return parser


def _setup_add_command(subparsers):
    """Setup the 'add' command and its subcommands."""
    add_parser = subparsers.add_parser('add', help='Add resources')
    add_subparsers = add_parser.add_subparsers(dest='subcommand', help='Add subcommands', required=True)

    add_key = add_subparsers.add_parser('keys', help='Safe create or append API key into file')
    add_key.add_argument('file', nargs='?', default='publisher_keys.json',
                         help='File to store API keys (default: publisher_keys.json)')
    add_key.add_argument('--api_key', help='API key for Piano authentication')
    add_key.add_argument('--site_id', type=int, help='Site ID for the Piano account')
    add_key.add_argument('--name', help='Name for the API key entry')
    add_key.add_argument('--indent', action='store_true', default=True,
                         help='Indent JSON output (default: True)')
    add_key.add_argument('--from-env', action='store_true',
                         help='Load API key and site ID from environment variables')


def _setup_test_command(subparsers):
    """Setup the 'test' command."""
    test_parser = subparsers.add_parser('test', help='Run unit tests')
    test_parser.add_argument('--pattern', default='test*.py',
                             help='Pattern to match test files (default: test*.py)')
    test_parser.add_argument('--verbosity', type=int, default=2, choices=[0, 1, 2],
                             help='Test output verbosity (default: 2)')
    test_parser.add_argument('--start-dir', default='./tests',
                             help='Directory to start discovery (default: ./tests)')


def _setup_init_command(subparsers):
    """Setup the 'init' command."""
    init_parser = subparsers.add_parser('init', help='Setup project environment (Not used in production)')
    init_parser.add_argument('--requirements', default='requirements.txt',
                             help='Requirements file to install (default: requirements.txt)')
    init_parser.add_argument('--venv-dir', default='.venv',
                             help='Virtual environment directory (default: .venv)')


def _setup_run_command(subparsers):
    """Setup the 'run' command."""
    run_parser = subparsers.add_parser('run', help='Run the main application')
    run_parser.add_argument('--skip-env', action='store_true',
                            help='Skip loading environment variables')
    run_parser.add_argument('--dry-run', action='store_true',
                            help='Simulate execution without running main.py')


def handle_test_command(args):
    """Handle the test command execution."""
    os.environ['API_ENDPOINT'] = "https://sandbox-api-esp.piano.io"

    loader = unittest.TestLoader()
    suite = loader.discover(args.start_dir, pattern=args.pattern)
    runner = unittest.TextTestRunner(verbosity=args.verbosity)
    result = runner.run(suite)

    sys.exit(0 if result.wasSuccessful() else 1)


def handle_add_keys_command(args, parser):
    """Handle the add keys subcommand."""
    if args.from_env:
        setup_from_env(args.file)
    else:
        if not args.api_key or not args.site_id:
            parser.error("--api_key and --site_id are required when not using --from-env")
        create_or_append_key(args.file, args.api_key, args.site_id, args.name, args.indent)


def handle_init_command(args):
    """Handle the init command execution."""
    print(f"Creating virtual environment at {args.venv_dir}...")
    if os.system(f"python3 -m venv {args.venv_dir}") != 0:
        print("Error: Failed to create virtual environment")
        sys.exit(1)

    print(f"Installing requirements from {args.requirements}...")
    if os.system(f"{args.venv_dir}/bin/pip install -r {args.requirements}") != 0:
        print("Error: Failed to install requirements")
        sys.exit(1)

    print("Setup completed successfully!")
    sys.exit(0)


def handle_run_command(args):
    """Handle the run command execution."""
    print(f"Starting application...")
    print(args.skip_env, args.dry_run)
    if not args.skip_env and not args.dry_run:
        setup_from_env('publisher_keys.json')
        if "API_ENDPOINT" not in os.environ:
            print("Error: API_ENDPOINT environment variable not found")
            print("Please set it to the Piano API endpoint")
            sys.exit(1)
        print("API keys loaded from publisher_keys.json")

    print("Executing")
    if not args.dry_run:
        if os.system("python3 main.py") != 0:
            print("Error: Failed to execute main.py")
            sys.exit(1)
    else:
        std = type("stdClass", #name
                   (), # parent classes
                   { # equivalent of stdClass in php
            "start_dir": str(Path(f"{os.getcwd()}/tests/")),
            "pattern": f"test_*.py",
            "verbosity": 0
        } # current params
                   )

        handle_test_command(std)
        print("Dry run completed successfully!")

    sys.exit(0)


def main():
    """Main entry point for the management script."""
    parser = parser_args_setup()
    args = parser.parse_args()

    match args.command:
        case "test":
            handle_test_command(args)
        case "add":
            if args.subcommand == "keys":
                handle_add_keys_command(args, parser)
        case "init":
            handle_init_command(args)
        case "run":
            handle_run_command(args)
        case _:
            parser.print_help()
            sys.exit(1)


if __name__ == '__main__':
    main()
